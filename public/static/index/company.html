{extend name="index/base" /}
{block name="content"}		
<!-- start: Content -->
<div id="content" class="span10">


	<ul class="breadcrumb">
		<li>
			<i class="icon-home"></i>
			<a href="{:url('index/system/config')}">首页</a> 
			<i class="icon-angle-right"></i>
		</li>		
		<li><a href="javascript:void(0);">{:$title}</a></li>
	</ul>

	<div class="row-fluid sortable">		
		<div class="box span12">
			<div class="box-header" data-original-title>
				<h2><i class="halflings-icon white th-list"></i><span class="break"></span>{:$title}</h2>
				<div class="box-icon">
					<a href="javascript:void(0);"><i class="halflings-icon white plus"></i></a>							
				</div>						
			</div>
			<div class="box-content">
				<div class="alert alert-success" style="display: none;">
					<button type="button" class="close" data-dismiss="alert">×</button>
					<strong></strong>
				</div>
				<div class="alert alert-error" style="display: none;">
					<button type="button" class="close" data-dismiss="alert">×</button>
					<strong></strong>
				</div>
				<table class="table table-striped">
					<thead>
						<tr>
							<th style="text-align: center;">ID</th>
							<th style="text-align: center;">公司名称</th>
							<th style="text-align: center;">联系人</th>
							<th style="text-align: center;">联系方式</th>
							<th style="text-align: center;">登录规则</th>
							<th style="text-align: center;">发布规则</th>							
							<th style="text-align: center;">录入时间</th>
							<th style="text-align: center;">操作</th>   									  
						</tr>
					</thead>   
					<tbody>
						{foreach name="company" item="vo"}
						<tr>
							<td style="text-align: center;">{:$vo.id}</td>
							<td style="text-align: center;">{:$vo.company}</td>
							<td style="text-align: center;">{:$vo.contact_person}</td>
							<td style="text-align: center;">{:$vo.mobile}</td>
							<td style="text-align: center;"><a href="{:url('index/outside/loginroute',array('company_id'=>$vo['id']))}" style="text-decoration: underline;">登录规则</a></td>
							<td style="text-align: center;"><a href="{:url('index/outside/publishrules',array('company_id'=>$vo['id']))}" style="text-decoration: underline;">发布规则</a></td>						
							<td style="text-align: center;">{:$vo.addtime}</td>
							<td style="text-align: center;">
								<a class="btn btn-info" href="javascript:void(0)">
									<i class="halflings-icon white edit"></i>  
								</a>
								<a class="btn btn-danger" alt="{:$vo.id}" href="JavaScript:void(0);">
									<i class="halflings-icon white trash"></i> 
								</a>
							</td>   
						</tr>
						{/foreach}
					</tbody>
				</table>  
				<div class="pagination pagination-centered" style="float:right">
					{:$page}
				</div>        
			</div>
		</div><!--/span-->

	</div><!--/row-->

</div><!--/.fluid-container-->

<!-- end: Content -->
</div><!--/#content.span10-->
</div><!--/fluid-row-->
<div class="modal hide fade" id="myModal" style="left: 48%;width: 32%">
	<div class="modal-header">
		<button type="button" class="close" data-dismiss="modal">×</button>
		<h3>添加公司</h3>
	</div>
	<div class="modal-body">
		<form class="form-horizontal" method="POST" action="{:url('index/outside/add')}">
			<input type="hidden" name="id" value="">
			<fieldset>				
				<div class="control-group error">
					<label class="control-label"><font color="red">* </font>公司名称</label>
					<div class="controls">
						<input type="text" class="input-xlarge" name="company"  value="">
						<span class="help-inline">请输入公司名称</span>
					</div>
				</div>
				<div class="control-group error">
					<label class="control-label"><font color="red">* </font>联系人</label>
					<div class="controls">
						<input type="text" class="input-xlarge" name="contact_person"  value="">
						<span class="help-inline">请输入联系人</span>
					</div>
				</div>
				<div class="control-group error">
					<label class="control-label"><font color="red">* </font>联系电话</label>
					<div class="controls">
						<input type="text" class="input-xlarge" name="mobile"  value="">
						<span class="help-inline">请输入联系电话</span>
					</div>
				</div>							
			</fieldset>
		</form>
	</div>
	<div class="modal-footer">
		<a href="JavaScript:void(0);" class="btn" data-dismiss="modal">Close</a>
		<a href="JavaScript:void(0);" class="btn btn-primary">Save</a>
	</div>
</div>
<div class="clearfix"></div>

<!-- start: JavaScript-->
<script src="__INDEX__js/jquery-1.9.1.min.js"></script>
<script src="__INDEX__js/jquery-migrate-1.0.0.min.js"></script>

<script src="__INDEX__js/jquery-ui-1.10.0.custom.min.js"></script>

<script src="__INDEX__js/jquery.ui.touch-punch.js"></script>

<script src="__INDEX__js/modernizr.js"></script>

<script src="__INDEX__js/bootstrap.min.js"></script>

<script src="__INDEX__js/jquery.cookie.js"></script>

<script src='__INDEX__js/fullcalendar.min.js'></script>

<script src='__INDEX__js/jquery.dataTables.min.js'></script>

<script src="__INDEX__js/excanvas.js"></script>
<script src="__INDEX__js/jquery.flot.js"></script>
<script src="__INDEX__js/jquery.flot.pie.js"></script>
<script src="__INDEX__js/jquery.flot.stack.js"></script>
<script src="__INDEX__js/jquery.flot.resize.min.js"></script>

<script src="__INDEX__js/jquery.chosen.min.js"></script>

<script src="__INDEX__js/jquery.uniform.min.js"></script>

<script src="__INDEX__js/jquery.cleditor.min.js"></script>

<script src="__INDEX__js/jquery.noty.js"></script>

<script src="__INDEX__js/jquery.elfinder.min.js"></script>

<script src="__INDEX__js/jquery.raty.min.js"></script>

<script src="__INDEX__js/jquery.iphone.toggle.js"></script>

<script src="__INDEX__js/jquery.uploadify-3.1.min.js"></script>

<script src="__INDEX__js/jquery.gritter.min.js"></script>

<script src="__INDEX__js/jquery.imagesloaded.js"></script>

<script src="__INDEX__js/jquery.masonry.min.js"></script>

<script src="__INDEX__js/jquery.knob.modified.js"></script>

<script src="__INDEX__js/jquery.sparkline.min.js"></script>

<script src="__INDEX__js/counter.js"></script>

<script src="__INDEX__js/retina.js"></script>

<script src="__INDEX__js/custom.js"></script>
<script src="__INDEX__js/jquery.form.js"></script>
<script>
	$(function(){

		$('.box-icon').click(function(){
			$("input[name='id']").val('');
			$('#myModal .modal-header h3').html('添加公司');
			$('#myModal').modal({backdrop: 'static', keyboard: false});
		})
		$('.btn-info').click(function(){
			$('#myModal .modal-header h3').html('修改公司');
			$('#myModal').modal({backdrop: 'static', keyboard: false});			
			var  id = $(this).parents('tr').find('td').eq(0).html();
			var  company = $(this).parents('tr').find('td').eq(1).html();
			var  contact_person = $(this).parents('tr').find('td').eq(2).html();
			var  mobile = $(this).parents('tr').find('td').eq(3).html();
			$("input[name='id']").val(id);
			$("input[name='company").val(company);
			$("input[name='company").next().hide();	
			$("input[name='company']").parents('.control-group').removeClass('error')
			$("input[name='contact_person").val(contact_person);
			$("input[name='contact_person").next().hide();	
			$("input[name='contact_person']").parents('.control-group').removeClass('error')
			$("input[name='mobile").val(mobile);
			$("input[name='mobile").next().hide();	
			$("input[name='mobile']").parents('.control-group').removeClass('error')
		})
		$('input[name="company"]').blur(function(){
			if ($(this).val()!='')
			{
				$("input[name='company").next().hide();	
				$("input[name='company']").parents('.control-group').removeClass('error')
			}
		})
		$('input[name="contact_person"]').blur(function(){
			if ($(this).val()!='')
			{
				$("input[name='contact_person").next().hide();	
				$("input[name='contact_person']").parents('.control-group').removeClass('error')
			}
		})
		$('input[name="mobile"]').blur(function(){
			if ($(this).val()!='')
			{
				$("input[name='mobile").next().hide();	
				$("input[name='mobile']").parents('.control-group').removeClass('error')
			}
		})
		//删除
		$('.btn-danger').click(function(){
			var _this = $(this);
			var company_id = $(this).attr('alt');
			if (company_id=='')
			{
				alert('参数错误，刷新当前页面！');
				window.location.reload();
				return false;
			}			
			$.ajax({    
				type: 'POST',    
				url: "{:url('index/outside/delete')}",
				dataType:"json",    
				data:{
					"company_id":company_id
				},
				success:function(data)
				{
					if(data.status==200)
					{
						_this.parents('tr').remove();
						return false;
					}else
					{
						$('.alert-error').find('strong').html(data.msg);
						$('.alert-error').css('display','block')
						$('.alert-error').fadeOut(3000)
					}    
				},
				error:function(xhr){ 
					$('.alert-error').find('strong').html('请求数据失败，请联系技术人员');
					$('.alert-error').css('display','block')
					$('.alert-error').fadeOut(3000)
				} 	

			});

		})
		$(document).on('click','.btn-primary',function(){
			var _this = $(this);   
		//添加或者修改权限		
		$(".form-horizontal").ajaxSubmit({  		
			dataType:"json",    
			beforeSend: function() { 
				_this.removeClass('btn-primary');
			},    	
			success:function(data)
			{
				_this.addClass('btn-primary');
				if (data.status==404)
				{
					$('#myModal').modal('hide')
					$('.alert-error').find('strong').html(data.message);
					$('.alert-error').css('display','block')
					$('.alert-error').fadeOut(3000)
					return false;
				}else if (data.status!=200)
				{
					$("input[name='"+data.name+"']").next().show();	
					$("input[name='"+data.name+"']").parents('.control-group').addClass('error')		  				
					return false;
				}else
				{
					$('#myModal').modal('hide')
					$('.alert-success').find('strong').html(data.message);
					$('.alert-success').css('display','block')
					$('.alert-success').fadeOut(3000);
	        	 	//sleep(3000);
	        	 	setTimeout(function(){  //使用  setTimeout（）方法设定定时2000毫秒
					window.location.reload();//页面刷新
				},3000); 
	        	 }

	        	},
	        error:function(xhr){ //上传失败 
	        	$('.alert-error').find('strong').html('操作失败');
	        	$('.alert-error').css('display','block')
	        	$('.alert-error').fadeOut(3000)
	        } 	

	    });

	})
	})	
</script>
<!-- end: JavaScript-->
{/block}
