	{extend name="index/base" /}
	{block name="content"}		
	<!-- start: Content -->
	<div id="content" class="span10">


		<ul class="breadcrumb">
			<li>
				<i class="icon-home"></i>
				<a href="{:url('index/index/home')}">首页</a> 
				<i class="icon-angle-right"></i>
			</li>
			<li><a href="javascript:void(0);">{:$title}</a></li>
		</ul>

		<div class="row-fluid sortable">		
			<div class="box span12">
				<div class="box-header" data-original-title>
					<h2><i class="halflings-icon white th-list"></i><span class="break"></span>{:$title}</h2>
					<div class="box-icon">
						<a href="javascript:void(0);"><i class="halflings-icon white plus"></i></a>							
					</div>						
				</div>
				<div class="box-content">
					<div class="alert alert-success" style="display: none;">
						<button type="button" class="close" data-dismiss="alert">×</button>
						<strong></strong>
					</div>
					<div class="alert alert-error" style="display: none;">
						<button type="button" class="close" data-dismiss="alert">×</button>
						<strong></strong>
					</div>
					<table class="table table-striped">
						<thead>
							<tr>
								<th style="text-align: center;">id</th>
								<th style="text-align: center;">权限组名称</th>
								<th style="text-align: center;">权限列( * 代表全权限)</th>
								<th style="text-align: center;">操作</th>   									  
							</tr>
						</thead>   
						<tbody>
							{foreach name="group" item="vo"}
							<tr>
								<td style="text-align: center;">{:$vo.id}</td>
								<td style="text-align: center;">{:$vo.group_name}</td>
								<td style="text-align: center;">{:$vo.group_list}</td>
								<td style="text-align: center;">
									<a class="btn btn-info" alt="{:$vo.id}" href="JavaScript:void(0);">
										<i class="halflings-icon white edit"></i>  
									</a>
								</td> 
							</tr>
							{/foreach}
						</tbody>
					</table>  
					<div class="pagination pagination-centered" style="float:right">
						{:$page}
					</div>        
				</div>
			</div><!--/span-->

		</div><!--/row-->

	</div><!--/.fluid-container-->

	<!-- end: Content -->
</div><!--/#content.span10-->
</div><!--/fluid-row-->

<div class="modal hide fade" id="myModal" style="left: 39%;width: 50%">
	<div class="modal-header">
		<button type="button" class="close" data-dismiss="modal">×</button>
		<h3></h3>
	</div>
	<div class="modal-body" style="max-height: 530px;">
		<form class="form-horizontal" method="POST" action="{:url('index/System/addGroup')}">
			<input type="hidden" name="id" value="">
			<div class="control-group error">
				<label class="control-label" for="inputError"><font color="red">* </font>权限组名称</label>
				<div class="controls">
					<input type="text" id="inputError" name="group_name">
					<span class="help-inline">请输入权限组名称</span>
				</div>
			</div>
			<fieldset>				
			</fieldset>
		</form>
	</div>
	<div class="modal-footer">
		<a href="JavaScript:void(0);" class="btn" data-dismiss="modal">Close</a>
		<a href="JavaScript:void(0);" class="btn btn-primary">Save</a>
	</div>
</div>

<div class="clearfix"></div>

<!-- start: JavaScript-->
<script src="__INDEX__js/jquery-1.9.1.min.js"></script>
<script src="__INDEX__js/jquery-migrate-1.0.0.min.js"></script>

<script src="__INDEX__js/jquery-ui-1.10.0.custom.min.js"></script>

<script src="__INDEX__js/jquery.ui.touch-punch.js"></script>

<script src="__INDEX__js/modernizr.js"></script>

<script src="__INDEX__js/bootstrap.min.js"></script>

<script src="__INDEX__js/jquery.cookie.js"></script>

<script src='__INDEX__js/fullcalendar.min.js'></script>

<script src='__INDEX__js/jquery.dataTables.min.js'></script>

<script src="__INDEX__js/excanvas.js"></script>
<script src="__INDEX__js/jquery.flot.js"></script>
<script src="__INDEX__js/jquery.flot.pie.js"></script>
<script src="__INDEX__js/jquery.flot.stack.js"></script>
<script src="__INDEX__js/jquery.flot.resize.min.js"></script>

<script src="__INDEX__js/jquery.chosen.min.js"></script>

<script src="__INDEX__js/jquery.uniform.min.js"></script>

<script src="__INDEX__js/jquery.cleditor.min.js"></script>

<script src="__INDEX__js/jquery.noty.js"></script>

<script src="__INDEX__js/jquery.elfinder.min.js"></script>

<script src="__INDEX__js/jquery.raty.min.js"></script>

<script src="__INDEX__js/jquery.iphone.toggle.js"></script>

<script src="__INDEX__js/jquery.uploadify-3.1.min.js"></script>

<script src="__INDEX__js/jquery.gritter.min.js"></script>

<script src="__INDEX__js/jquery.imagesloaded.js"></script>

<script src="__INDEX__js/jquery.masonry.min.js"></script>

<script src="__INDEX__js/jquery.knob.modified.js"></script>

<script src="__INDEX__js/jquery.sparkline.min.js"></script>

<script src="__INDEX__js/counter.js"></script>

<script src="__INDEX__js/retina.js"></script>

<script src="__INDEX__js/custom.js"></script>
<script src="__INDEX__js/jquery.form.js"></script>
<script>	
	$(function(){
		$('input[name="group_name"]').blur(function(){
			if ($(this).val()!='')
			{
				$("input[name='group_name").next().hide();	
				$("input[name='group_name']").parents('.control-group').removeClass('error')
			}
		})
		//全选
		$(document).on('click','input[name="all[]"]',function(){	
			var checker = $(this).prop('checked');	
			$(this).parent('label').next('.controls').find('input[name="group_list[]"]').each(function(index,e){
				$(this).prop('checked',checker)
			})
		})
		//去除全选
		$(document).on('click','input[name="group_list[]"]',function(){
			var checker = $(this).prop('checked');
			var falg = true;	
			$(this).parents('.controls').find('input[name="group_list[]"]').each(function(){
				if(!$(this).prop('checked'))
				{
					falg = false;
					$(this).parents('.control-group').find('input[name="all[]"]').prop('checked',false);
				}
			});
			if (falg)
			{
				$(this).parents('.control-group').find('input[name="all[]"]').prop('checked',true);
			}
		})
		$(document).on('click','.btn-primary',function(){
			var _this = $(this);   
			//添加或者修改权限		
			$(".form-horizontal").ajaxSubmit({  		
				dataType:"json",
				beforeSend: function() { 
					_this.removeClass('btn-primary');
				},     	
				success:function(data)
				{
					_this.addClass('btn-primary');
					if (data.status==201)
					{
						$('#myModal').modal('hide')
						$('.alert-error').find('strong').html(data.message);
						$('.alert-error').css('display','block')
						$('.alert-error').fadeOut(3000)						
					}else if (data.status==404)
					{
						$('#myModal').modal('hide')
						$('.alert-error').find('strong').html(data.message);
						$('.alert-error').css('display','block')
						$('.alert-error').fadeOut(3000)
						return false;
					}else if (data.status ==200) 
					{

						$('#myModal').modal('hide')
						$('.alert-success').find('strong').html(data.message);
						$('.alert-success').css('display','block')
						$('.alert-success').fadeOut(3000);
			        	 	setTimeout(function(){  //使用  setTimeout（）方法设定定时2000毫秒
							window.location.reload();//页面刷新
						},3000); 
			        	 }else
			        	 {

			        	 	$("input[name='"+data.name+"']").next().show();	
			        	 	$("input[name='"+data.name+"']").parents('.control-group').addClass('error')		  				
			        	 	return false;
			        	 }

			        	},
		        error:function(xhr){ //上传失败 
		        	$('.alert-error').find('strong').html('上传失败');
		        	$('.alert-error').css('display','block')
		        	$('.alert-error').fadeOut(3000)
		        } 	

		    });

		})
		//修改权限组权限
		$('.btn-info').click(function(){
			var id = $(this).attr('alt');
			$("input[name='id']").val(id);
			$('#myModal .modal-header h3').html('修改权限组');
			$.ajax({    
				type: 'POST',    
				url: '{:url("index/system/authDetail")}', 
				dataType:"json",    
				data:{
					"id":id
				}, 
				success:function(data)
				{
					if (data.status==404)
					{
						$('#myModal').modal('hide')
						$('.alert-error').find('strong').html(data.message);
						$('.alert-error').css('display','block')
						$('.alert-error').fadeOut(3000)
						return false;
					}
					$('#myModal').modal({backdrop: 'static', keyboard: false});
					$('#inputError').val(data.group_name);
					$('#inputError').parents('.control-group').removeClass('error');
					$('#inputError').parents('.control-group').find('.help-inline').hide();
					var parents = data.parents;
					var html ='';
					for (var i = 0; i < parents.length; i++)
					{
						html+='<div class="control-group" style="border-bottom: solid 1px #eee">';
						html+='<label class="checkbox inline" style="float: left;margin-left: 80px;margin-top: 10px;"><input ';
						if (data.select[0]=='*')
						{
							html+=' checked ';
						}else
						{
							var selectAll = data.select_all
							for (var p = 0; p < selectAll.length; p++) 
							{
								if (selectAll[p]==parents[i].id)
								{
									html+=' checked ';
								}
							}
						}
						html+='type="checkbox" name="all[]"  value="'+parents[i].url+'">'+parents[i].name+'</label>';
						html+='<div class="controls">';				
						var obj = parents[i].child;
						for (var j = 0; j < obj.length; j++)
						{			
							html+='<label class="checkbox inline"  style="width:230px;margin-left:0px; float:left;">';	
							html+='<input ';
							if (data.select[0]=='*')
							{
								html+=' checked ';
							}else
							{
								var select = data.select
								for (var q = 0; q < select.length; q++) 
								{
									if (select[q]==obj[j].id)
									{
										html+=' checked ';
									}
								}
							}
							html+='type="checkbox" name="group_list[]" class="inlineCheckbox" value="'+obj[j].id+'">'+obj[j].name;	
							html+='</label>';																		
						}	
						html+='</div>';					
						html+='</div>';
					}
					$('.modal-body .form-horizontal fieldset').html(html);	
				},
				error:function(xhr){ 
					$('.alert-error').find('strong').html('请求数据失败，请联系技术人员');
					$('.alert-error').css('display','block')
					$('.alert-error').fadeOut(3000)
				} 	
			});	
		})
		$('.box-icon').click(function(){
			$("input[name='id']").val('');
			$('#myModal .modal-header h3').html('添加权限组');			
			$.ajax({    
				type: 'POST',    
				url: '{:url("index/system/authDetail")}', 
				dataType:"json",    
				data:{
					"id":''
				}, 
				success:function(data)
				{
					if (data.status==404)
					{
						$('#myModal').modal('hide')
						$('.alert-error').find('strong').html(data.message);
						$('.alert-error').css('display','block')
						$('.alert-error').fadeOut(3000)
						return false;
					}
					$('#myModal').modal({backdrop: 'static', keyboard: false});
					var html ='';
					for (var i = 0; i < data.length; i++)
					{
						html+='<div class="control-group" style="border-bottom: solid 1px #eee">';
						html+='<label class="checkbox inline" style="float: left;margin-left: 80px;margin-top: 10px;"><input type="checkbox" name="all[]" value="'+data[i].url+'">'+data[i].name+'</label>';
						html+='<div class="controls">';				
						var obj = data[i].child;
						for (var j = 0; j < obj.length; j++)
						{			
							html+='<label class="checkbox inline"  style="width:230px;margin-left:0px; float:left;">';	
							html+='<input type="checkbox" name="group_list[]" class="inlineCheckbox" value="'+obj[j].id+'">'+obj[j].name;	
							html+='</label>';																		
						}	
						html+='</div>';					
						html+='</div>';
					}
					$('.modal-body .form-horizontal fieldset').html(html);		
				},
				error:function(xhr){ 
					$('.alert-error').find('strong').html('请求数据失败，请联系技术人员');
					$('.alert-error').css('display','block')
					$('.alert-error').fadeOut(3000)
				} 	
			});	
		})
	})
</script>
<!-- end: JavaScript-->
{/block}
